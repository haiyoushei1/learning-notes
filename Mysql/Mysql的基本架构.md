# Mysql的基本架构

####  一、Mysql的结构：

Mysql可以分为两部分，Server层与存储引擎层。

Server层包括连接器，分析器，优化器，执行器，涵盖Mysql大多数核心功能，以及所有的内置函数。

存储引擎层负责数据的存储和提取

1. Server层包括

   - 连接器：管理与客户端的连接，进行权限验证 （后面也有个权限验证，不过和这个不一样，具体到那里再细说）
   - 分析器：词法分析，语法分析
   - 优化器：执行计划生成，索引选择
   - 执行器：操作引擎，返回结果
   - 包括所有的内置函数，所有跨存储引擎的

#### 二、连接器：

在使用Mysql时，会先连接到这个数据库上，就会先接触连接器。连接器负责建立连接，验证权限（验证有没有权限连接到这个数据库），维持和管理连接。

- 如果登陆是，用户名与密码认证通过，连接器会到权限表查出拥有的权限，后续这个连接的权限判断逻辑都依赖此时读到的权限。所以如果一个连接建立后，管理员修改这个用户的权限，也只会在下次连接建立时生效。

长连接与短连接：

- 长连接：连接成功后，如果客户端持续有请求，一直使用同一个连接。
- 短连接：每次执行完很少的几次查询后就断开连接，下次查询再建立

Mysql执行过程中临时使用的内存保存在连接对象中，只有连接断开后，才会回收这些内存，所以，如果长连接很多，那么Mysql占用内存会飞涨。所以连接池会有连接最大保持时间的参数。

解决这个问题有以下方法：

- 定期断开长连接：使用一段时间或者程序里面判断执行过一个内存过大的查询后断开连接
- 执行mysql_reset_connection来重新初始化连接资源：在Mysql5.7以上的版本，可以在执行一个内存过大的查询后使用mysql_reset_connection来重新初始化连接资源。这个过程不需要重新连接和重新做权限验证，但会把连接恢复到刚刚建立完成时的状态

#### 三、分析器

对输入的SQL进行解析

- 词法分析：Mysql要识别输入的SQL中字符串的含义是什么

- 语法分析：在进行词法分析后，语法分析器会将词法分析的结果根据语法规则，判断这个SQL语句是否满足Mysql语法

  > You have an error in your SQL syntax 这个报错就是语句不对，一般这个会提示第一个出现错误的地方，注意关注use near

分析器处理语法和解析查询，生成一个对应的解析树；预处理器进一步检查解析树的合法，比如表的是否存在，列是否存在，别名是否有歧义。如果通过生成一个新的解析树，再提交给优化器。

#### 四、优化器

经过分析器后，Mysql知道要做什么，接下来是怎么做。在交付执行器前还需要经过优化器的处理。

优化器在有多个索引的时候，决定选择哪个索引，或者在两个表关联的时候，决定各个表的连接顺序。

#### 五、执行器

在执行器进行执行之前，要判断用户对这个表T是否有查询的权限，如果没有就会返回权限错误

> mysql> select * from T where ID=10;
>
> ERROR 1142 (42000): SELECT command denied to user 'b'@'localhost' for table 'T'

实际上在优化器之前也有一次权限验证，叫precheck，因为precheck无法对运行时涉及的表进行权限验证，比如触发器情况，所以在执行器做一次权限验证。

**这里的权限验证和连接器的权限验证还不一样，那个验证是账号密码对不对，这里是验证用户对某个表是否有权限**





