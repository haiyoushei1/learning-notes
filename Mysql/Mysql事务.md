# Mysql事务

#### 一、什么是事务

事务是一组sql语句组成数据库逻辑处理单元，在这组sql操作中，要么全部执行成功，要么全部执行失败。这样能保证数据一致性。在Mysql中事务由引擎层实现的，不是所有的引擎都支持事务，比如MyISAM就不支持。

#### 二、事务的特性

事务的特性分四种：原子性，一致性，隔离性，持久性（即ACID）

- 原子性：事务是最小的执行单位，不允许分割。事务的原子性确保操作要么全部完成，要么全部失效，不会停在中间的某个环节。事务在执行过程中出现错误会回滚。该特性由undolog支持，具体请看undolog笔记

- 一致性：在事务开始之前和事务结束之后，数据库的完整性没有破坏。（关于这个我的理解就是，一致性是我们使用事务的目的，保证一致性是需要应用程序来保证，比如出错需要回滚，而不是硬提交）

- 隔离性：在事务并发的执行下，防止多个事务由于交叉执行而导致的数据不一致。

  事务的隔离分为四个级别：读未提交，读提交，可重复，串行化

  分别对应三种事务并发执行可能出现的问题：脏读，不可重复读，幻读（具体在下面会细说）

- 持久性：事务结束后，对数据的修改是持久的，即使系统故障也不会丢弃，该特性由redolog支持，具体请看redolog笔记

#### 三、事务的隔离性：

1. 三种问题：
   - 脏读：读到其他事务未提交的数据，假如这个事务最后没提交，回滚了，那这个就数据不一致了。
   - 不可重复读：一个事务读取到其他事务更新或删除后已提交的数据，关键在于更新、删除操作，提交的事务
   - 幻读：一个事务读取了其他事务插入已经提交的数据，导致两次读取的条数是不同的，关键在于插入，提交的事务  
   
2. 四种隔离级别：
   - 读未提交：一个事务还没提交时，它的改变就可以被其他事务发现
   - 读提交：一个事务提交之后，它的变更才能被其他事务发现
   - 可重复读：  一个事务执行过程中，看到的数据总是和这个事务启动时看到的数据一致
   - 串行化：对于同一行数据，写会加写锁，读会加读锁，当读写锁冲突时，后访问的事务只有等前一个事务执行完成才能继续执行
   
   隔离级别越高，安全性越高但是性能会变低
   
   关于读提交和可重复读的区别：此处直接借用极客时间Mysql45讲的内容
   
   ![img](https://static001.geekbang.org/resource/image/7d/f8/7dea45932a6b722eb069d2264d0066f8.png)
   
   ![image-20210721170625360](C:\Users\12604\AppData\Roaming\Typora\typora-user-images\image-20210721170625360.png)
   
   可重复读与读提交的区别在于，数据库里面会创建一个视图，访问的时候以视图的逻辑结果为准。在可重复读的隔离级别下，这个视图是在事务启动的时候创建的，整个事务期间都是用这个视图；而对于读提交，是在每个sql开始执行的时候创建的。读未提交，直接返回记录上的最新值， 没有视图的概念；串行化，通过加锁的形式避免并发访问。
   
   可重复读的应用场景：在事务开启之后，希望事务在执行过程中，不要被打扰
